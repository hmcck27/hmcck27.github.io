---

title: nginx와 apache
categories: [Server]
tags: [Server, Nginx, Apache]     # TAG names should always be lowercase
author:
name: Choi Jin Kyu
link: https://github.com/hmcck27
toc: true
# date: 2022-02-05

img_path: /assets/img/mdImage/

---

# Apache VS Nginx

최근에 서비스를 릴리즈할 날이 다가오고 있어서 포스트를 작성을 많이 못했다.

흔히 백엔드 서버를 구성할때 어떤 종류의 서버를 사용하지 고민이 있을 수 있다.

뭐 사실 난 nginx만 사용해봤는데,

이번에 nginx를 깔면서 든 의문이 있었다.

nginx와 apache는 무엇이 다르길래 최근에 죄다 nginx를 사용하는 걸까 ?

사실 nginx를 위주로 많이 사용했던 나에게 apache라는 서버는 많이 들어는 봤지만 아예 생소한 개념이었다.

그래서 이번에 apache와 nginx의 차이점을 한번 정리해보고자 한다.

---

## 웹 서버

일단은 apache나 nginx나 둘다 웹 서버이다.

웹 서버가 뭐하는 친구일까 ?

웹 서버는 사용자의 브라우저에 페이지나 소스를 내려주는 역할을 한다.

주로 정적인 데이터를 처리한다.

그냥 예시를 한번 들어보자.

우리가 웹 서비스를 만들어서 실제로 배포한다고 가정해보자.

많은 사람들이 흔히 사용하는 AWS의 ec2 인스턴스를 하나 구독했다.

ec2 인스턴스는 그냥 하나의 컴퓨터라고 보면 된다. 대신 네트워크에 연결되어 있는 컴퓨터.

자 우리는 컴퓨터를 하나 샀다.

이 컴퓨터가 네트워크에 연결되어 있다고 해서, 이 컴퓨터에 뭔가 요청을 보내면 응답이 올까 ?

궁금하면 당장 집 노트북 ip로 해서 아무거나 쏴보자...

당연히 아무것도 안온다.

우리는 배포를 하지 않았다.

무언가 요청을 보냈을때 해당 요청을 받고, 복작복작 작업해서 작업물을 다시 요청자에게 리턴해주는 역할을 할 프로그램이 필요하다.

그게 웹 서버다.

그래서 우리는 ec2에 웹서버인 nginx를 깔았다.

자 이제 요청을 보내면 뭐가 올까 ?

당연히 에러 페이지만 온다. 아마 nginx 에러 페이지가 렌더링 될거다.

당연하다. 요청은 받았는데, 복작복작 작업을 해서 결과물을 만들어 줄 친구가 없다.

우리는 그 친구를 어플리케이션이라고 불른다.

바로 흔하게 사용하는 백엔드 어플리케이션 예를 들면 스프링, 장고, 플라스크가 그 작업을 해준다.

그래서 우리는 ec2에 스프링 war를 옮겨 넣었다.

이제 스프링을 로드시키면 된다 !

근데 어떻게 스프링 어플레케이션을 로드하지 ?

그냥 자바 파일 실행 ?

아니다. 자바 프로그램을 실행시킨다고 해보자.

프로세스는 하나만 떠있다.

nginx로 요청은 받았는데 해당 요청을 자바 프로그램이 처리하기 위해서는

자바 서블릿을 사용한다.

자바 서블릿을 누가 만들어 줄까 ?

거기서 tomcat이 나온다.

tomcat은 WAS라고 한다. Web application server.

was는 웹 서버가 받은 요청을 전달 받아서 자바 서블릿으로 만든후 스프링 어플리케이션으로 전달한다.

그럼 우리는 요청이 들어오고 요청을 처리하는 하나의 라이프 사이클을 이제 알 수 있다.

컴퓨터 - 웹 서버 - 웹 어플리케이션 서버 - 어플리케이션

얘기가 길어졌는데, 결국 웹 서버가 없으면 아무것도 못한다.

이 웹서버에는 크게 두가지 종류가 있다. apache와 nginx.

> 어 근데 웹 서버는 정적인 리소스를 처리한다고 했는데...? 실제 서버는 다양하게 내려줘야 하잖아 ?  
> -> 동적인 데이터를 다루는 것은 was + application이 한다 !

---

## Apache

요청당 스레드를 처리하는 구조를 가진다.
즉 하나의 요청의 하나의 스레드이다.
많은 요청이 들어올 수록 메모리 사용량을 비례해서 증가한다.
또 프로세스 하나가 관리하는 스레드의 수가 많아지고, process의 수도 증가하게 되면,  
context-swtiching의 비용이 증가하게 된다.  

아니 요청이 백만개 들어오면 ? 백만개의 스래드를 생성한다....
그러면 메모리가 작살난다.

apache의 이런 메모리 문제를 "일만개의 클라이언트 문제"라고 한다.  
즉 동시에 1만명이 접속해 있는 상황이라면, 요청에 비례해서 process, thread의 수가 증가한다면,  
아무리 효율적일 관리 전략을 사용한다고 해도 이미 thread가 10000개 라면 정말 처리가 곤란해진다.  

물론 이런 문제를 MPM에서도 apache 2.4 이후로 도입했다고 하는 event 전략으로 해결하고자 노력한다.  

### MPM

MPM은 apache의 요청 처리 전략이다.  
multi-module-process의 약자인데  
총 3가지의 전략이 있다.  

1. prefork
    
    자식 프로세스 하나가 싱글 쓰레드이다.   
    하나의 요청이 하나의 프로세스를 차지한다.   
    그 프로세스안에는 하나의 쓰레드가 존재한다.     
    여분의 자식 프로세스를 만들어서 요청이 들어왔을때, 새로 만들지 않아도 되게 동작한다.  
    그래서 prefork이다.   
    높은 성능이 필요할때 사용한다.   
    하나의 프로세스가 정지해도 다른 프로세스에는 영향이 없다.
    프로세스 간에 메모리를 공유하지 않는다.  
    
    
2. worker
    
    자식 프로세스가 여러개의 쓰레드를 가지고,   
    하나의 요청은 하나의 쓰레드를 차지한다.   
    위의 prefork보다 당연히 성능이 낮다.   
    프로세스 하나가 여러개의 멀티 쓰레드니까. 
    상대적으로 경량화한것이다.  
    자원도 당연히 적게 사용한다.   
    메모리 공간을 복수의 쓰레드가 공유하므로 리소스 경합이 발생할 수 있다.  

    
3. event
    
    nginx와 유사한 전략이다.  
    이벤트 리스너를 사용한다.  
    리스닝 소켓과 기타 모든 소켓을 처리하는 각 프로세스를 위한 전용 리스너 스레드를 사용한다.  

### apache의 장점 
근데 단점만 설명한것 같은데 그래도 apache를 사용해야 하는 순간이 있을 수 있다.  
그걸 위해서 장점이 뭐일지 알아보자.  
일단 단점은 곧 장점이 될수 있다.  
메모리를 많이 사용함은 고성능 처리에는 역으로 유리할 수 있다는 말이다.  
그리고 apache는 다양한  모듈이 있다.  
apache가 안정성, 확장성, 호환성에는 큰 장점이 있다.  
따라서 복잡한 cgi 처리, 동영상 데이터 전송같은 안정성이 높아야 하는 경우에는 사용하면 괜찮을 것 같다..!  
(근데 cgi는 이제는 사용하는 사람을 못봤다. 학교에서만 실습으로만 하는듯...)
cgi는 was없이 web server에서 동적인 데이터를 처리하는 프로그램이다.  

---

## Nginx

위에서 apache의 경우 메모리 문제, 잦은 context-switching의 문제가 있을 수 있었다.  
이런 문제를 해결하기 위해서 nginx가 있다.  
nginx는 대용량을 트래픽을 수월하게 처리하기 위해서 가벼움과 높은 성능에 초점을 맞춘 웹서버이다.  
그리고 단순 웹 서버의 기능을 넘어서 reverse-proxy, load-balancing, mail-proxy, http caching의 기능들을 지원한다.  

nginx은 event-driven 구조를 가진다.  
event-driven이 무슨 말이냐..  

프로그램의 흐름이 event에 의해서 결정된다는 말이다.  
단순하게 설명하면, 하나의 thread에서 여러 request를 처리하고,  
event-handler에서 비동기 방식으로 request를 처리한다.  
request가 들어오면 해당 request를 처리하는 구체적인 흐름은 event-listener에게 맡기고,  
서버는 다른일을 하게 된다. -> 비동기이다.  

nginx를 깔아본 사람들은 알겠지만,  
service nginx start를 실행하면, system에 내장된 명령어를 통해서 nginx가 실행된다.  
그리고 ps -ef를 쳐보자.  
기본적으로 nginx가 두개의 프로세스를 사용함을 알 수 있다. -> 물론 더 늘릴 수도 있다.  

이 두개의 프로세스는 두 종류이다. master와 worder.   
어떤 상황에서도 master는 1개이다. worder는 원한다면 개발자가 복수로 늘릴 수 있다.  
-> 여기서 의문이 생긴다. 원한다면 복수로 늘린다는 말은 요청의 수가 증가, 감소함에 따라서 자동으로 더 process, thread를 생성하지 않는다는 말이다.  우리가 원하는 설정대로 process의 수를 제한하는 것이다.  

이게 바로 apache와의 핵심 차이이다.  
apache가 request에 따라서 process, thread를 증가시킨다면, nginx는 제한된 수로만 운영된다.  

그러면 위에서 언급한 "일만개의 클라이언트 문제"를 해결할 수 있다.  

### Nginx의 장점

적은 양의 자원으로 많은 트래픽을 처리할 수 있다.  
요청이 많아진다고 추가적으로 자원을 사용하지 않기 때문이다.  
근데 당연하지만 요청이 많아지면 그거 처리는 또 쉽지 않다...!   
nginx는 무적이 아니다.  



    